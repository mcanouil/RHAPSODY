---
title: "RHAPSODY WP3 Pre-Diabetes Analysis Plan"
subtitle: "(Version 0.9.3)"
author: "MickaÃ«l Canouil, Ph.D."
date: '`r format(Sys.Date(), "%d %B %Y")`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

# Files description
At this stage, you were provided with the following files from [the (hidden) Gist](https://gist.github.com/mcanouil/15362a96c1561bb51af98760b41c478e) (don't share outside RHAPSODY):

  * `README.Rmd`, the file you are actually reading;
  * `RHAPSODY_WP3_PreDiab.Rmd`, a Rmarkdown script which perform:
      * opal node access,
      * phenotype QC, 
      * preliminary modelling,
      * VCFs formatting/filtering,
      * variants analysis;
  * `RHAPSODY_WP3_PreDiab_DEBUG.R`, a small part of the main Rmarkdown script, which includes only node access and phenotype QC;
  * `RunAnalysis.sh`, a shell script to run the whole analysis (parameters have to be filled properly according to your informations);
  * `handleVCF.sh`, the shell script used to format/filter VCFs files prior to the variant analysis. This shell script is also included within the main script, but you can use it directly as a standalone, if so (or if your already done formatting and don't want to do it again), parameter `format_vcfs` must be set to `FALSE`).
  * `opal_credentials.txt`, the server, login and password informations to access phenotype data on your local node;
  * `Install_Rpackages.R`, a R script which install a predefined version of all R packages loaded in the Rmarkdown script, only if needed (also avaiable within the main script).
  
`r if (knitr:::is_latex_output()) {'\\clearpage'}`

# Run the analysis
## R Setup
Please use `r R.version.string` (if not possible, newer version "3.4.*" can be used).  
If VCFtools is not available on your machine, please install it: [VCFtools](https://vcftools.github.io/).  
Be sure the needed packages are installed (this is also done within the Rmarkdown script) or copy/paste the following command.
`session_info.csv` provided should be used, by default in the working directory.
```{r}
if (!'tidyverse'%in%installed.packages()[, 'Package']) {
  install.package(pkgs = 'tidyverse', repos = 'http://cran.us.r-project.org')
}
library(tidyverse)
check_packages_version <- function(list_packages, session_info_csv = 'session_info.csv') {
  check_packages <- function(package) {
    if (!package%in%installed.packages()[, 'Package']) {
      install.packages(
  			pkgs = package, 
  			repos = c(
  			  'http://cran.us.r-project.org',
  			  'https://cran.rstudio.com/'
  		  ),
  			dependencies = TRUE
  		)
    }
    library(
      package = package, 
      character.only = TRUE, 
      quietly = TRUE, 
      warn.conflicts = FALSE
    )
  }
  
  invisible(sapply(c('devtools', 'tidyverse'), check_packages))

  read_csv(file = session_info_csv) %>% 
    dplyr::mutate(
      local_version = purrr::map(
        .x = package, 
        .f = function(x) {
          if (x %in% utils::installed.packages()[, 'Package']) {
            utils::packageDescription(pkg = x, fields = 'Version')
          }
        }
      )
    ) %>% 
    filter(local_version!=version) %>% 
    dplyr::arrange(package) %>% 
    dplyr::mutate(
      install = purrr::map2(
        .x = package, 
        .y = version,
        .f = function(x, y) {
          devtools::install_version(
            package = x, 
            version = as.character(y), 
            repos = c(
              'https://rhap-fdb01.vital-it.ch/repo/', 
              'http://cran.us.r-project.org',
              'https://cran.rstudio.com/'
            )
          )
        }
      )
    )
  
  invisible(sapply(list_packages, check_packages))
  tidyverse::tidyverse_conflicts()
}

list_packages <- c(
  'devtools', 'parallel', 'grid', 'scales',
  'broom', 'viridis', 'readxl', 'writexl',
  'cowplot', 'knitr', 'kableExtra', 'lme4',
  'lmerTest', 'Hmisc', 'data.tree', 'opal'
)
check_packages_version(
  list_packages = list_packages, 
  session_info_csv = 'session_info.csv'
)
```

`r if (knitr:::is_latex_output()) {'\\clearpage'}`

## Using Docker
If you are familiar with Docker, you can find an image which include everything you need to run the analyses.

### Run the docker container with the latest image
To run the image, you can use the following command (need docker to be installed):
```{sh}
docker run \
  --name rhapsody \
  --hostname rhapsody \
  --detach \
  --volume /your_local_volume:/media/remote_volume \
  --publish 8787:8787 \
  --publish 22:22 \
  biostatgood/rapsody:latest
```
`"/your_local_volume"` is the path to the volume (where your data are located) on the machine when you run the docker software.  
`"/media/remote_volume"` will be the path within the docker container (keep `/media/` as root directory).

### Connect to the docker container
Login and password have been set respectively to `rhapsody` and `wp3` (`rhapsody` is root via `sudo`).
You can connect through SSH using standard IP address: `ssh rhapsody@localhost` (equivalent to `ssh rhapsody@127.0.0.1`).  
You can also connect through Rstudio using a web browser at `http://localhost:8787/` (equivalent to `http://127.0.0.1:8787/`).  
Once you are connected directly by SSH or with Rstudio, you can go to the bash terminal and change the password using `passwd` (just follow the instructions).

### Docker configuration
The (hidden) Gist s cloned in `/home/rhapsody/WP3/scripts`.  
Make sure after starting the Docker image to update the scripts, if necessary.
```{sh}
cd /home/rhapsody/WP3/scripts
git pull origin master
```

`VCFtools` is also installed in its latest version using github repository.  
`vcftools`binary is located in the default directory: `/usr/local/bin` (default path in the Rmarkdown scripts).

`r if (knitr:::is_latex_output()) {'\\clearpage'}`

## Run the Rmarkdown script
1. First, create (or change) the `opal_credentials.txt` with your informations.
2. Fill in the proper informations.
3. Set the `analysis_step`:
    1. Node access
    2. Phenotype QC
    3. Run Mixed Model without variants
    4. Check VCFs files
    5. Format VCFs files
    6. Run Mixed Model with (imputed) variants
    7. Check output files 
4. Run the R code below within interactive R session.
5. a/ If everything worked, you should have a HTML report.  
    Increment `analysis_step` and repeat steps 3 to 5.  
    b/ If something went wrong, you should have an error message, for example:
    ```{r}
    label: list_vcf (with options) 
    List of 2
     $ eval  : language params_steps$step_5
     $ engine: chr "sh"
    
    Quitting from lines 1597-1598 (RHAPSODY_WP3_PreDiab.Rmd) 
    Error in if (options$eval) { : argument is of length zero
    ```
    Either try to solve the issue yourself and/or send the informations to [mickael.canouil@cnrs.fr](mailto:mickael.canouil@cnrs.fr)

`r if (knitr:::is_latex_output()) {'\\clearpage'}`

```{sh}
#!/bin/sh

R --slave --silent <<RSCRIPT

# set the output directory or leave as is; 
# output will be generated where the Rmarkdown file is
working_directory <- './' 

analysis_step <- 7
cohort_name <- 'Cohort_Name'
author_name <- 'Firstname LASTNAME'
opal_credentials <- 'opal_credentials.txt'
vcf_directory <- '/media/.../vcf'
imputation_quality_tag <- 'INFO' # To be set according to VCF (could also be 'R2')


# Run the analysis
dir.create(path = working_directory, showWarnings = FALSE, mode = '0777')
rmarkdown::render(
  input = '/home/rhapsody/WP3/scripts/RHAPSODY_WP3_PreDiab.Rmd', 
  output_format = 'html_document', 
  output_file = paste0(
    'RHAPSODY_WP3_PreDiab_', 
    cohort_name, '_step', 
    analysis_step, '.html'
  ), 
  output_dir = working_directory,
  params = list(
    cohort_name = cohort_name, 
    author_name = author_name, 
    opal_credentials = opal_credentials,
    vcf_input_directory = vcf_directory, 
    imputation_quality_tag = imputation_quality_tag, 
    vcftools_binary_path = '/usr/local/bin',
    output_directory = working_directory,
    analysis_step = analysis_step,
    format_vcfs = TRUE,
    variants_analysis = TRUE,
    n_cpu = 2,
    echo = FALSE, # Should R code be printed in the report
    warning = FALSE, # Should warnings be printed in the report
    message = FALSE # Should messages be printed in the report
  ),
  encoding = 'UTF-8'
)
RSCRIPT
```
